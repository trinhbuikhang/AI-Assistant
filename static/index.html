<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Assistant</title>
  <!--
  CHANGES:
  - Added welcome screen with centered logo, dynamic greeting, "Powered by [model]", suggestion chips (pill-shaped, border #2A2A2A, hover #7C3AED)
  - Sidebar: gradient #141414 ‚Üí #0F0F0F, logo area with gradient avatar icon, + New Chat prominent (#7C3AED, hover #8B5CF6, + icon), width 280px, subtle right border #1E1E1E, noise texture overlay
  - Model selector: dropdown style with green dot indicator, chevron, pill styling
  - Conversation list: date groups (Today, Yesterday, Last 7 days), first line as title, hover "..." menu (clear), active item left accent bar #7C3AED + bg #161622
  - Header: 56px height, border-bottom #1A1A1A, model badge pill with pulsing green dot, backdrop-filter blur(10px), icon buttons (clear chat, settings)
  - Input: frosted glass panel full width (rgba(15,15,15,0.95), blur 20px), border-top #1A1A1A, input max-width 860px centered, inner shadow on textarea, attach button inside textarea left, send disabled when empty + scale(1.05) hover
  - Message bubbles: user gradient linear-gradient(135deg,#1E1E2E,#252535), border #2D2D3D, max-width 72%; AI left 2px accent #7C3AED on hover, 8px left padding; AI avatar gradient + box-shadow; 24px gap; messageIn animation (opacity, translateY 6px)
  - Typography: Inter 15px line-height 1.65, #E8E8E8; sidebar titles 13.5px font-weight 500; meta 11.5px #555; code JetBrains Mono 13px, bg #0D0D0D, border #222, Copy button top-right
  - Micro-interactions: sidebar item hover transition + padding-left 2px; New Chat scale on click; send button loading spinner when streaming; typing dots bounce #7C3AED, delays 0/150/300ms; scrollbar 4px #1E1E1E, thumb #333, hover #7C3AED
  - Depth: sidebar noise opacity 0.03; chat area bg #0C0C0E; vignette top/bottom gradient masks
  - Mobile: sidebar hidden by default, hamburger in header, full-width input and messages
  -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/variables.css">
  <link rel="stylesheet" href="/static/css/layout.css">
  <link rel="stylesheet" href="/static/css/sidebar.css">
  <link rel="stylesheet" href="/static/css/header.css">
  <link rel="stylesheet" href="/static/css/messages.css">
  <link rel="stylesheet" href="/static/css/welcome.css">
  <link rel="stylesheet" href="/static/css/message-bubbles.css">
  <link rel="stylesheet" href="/static/css/input.css">
  <link rel="stylesheet" href="/static/css/mobile.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
  <div id="ollamaBanner" class="ollama-banner" style="display:none" role="alert">
    <span id="ollamaBannerText"></span>
    <a href="https://ollama.ai" target="_blank" rel="noopener">Get Ollama</a>
    <button type="button" class="ollama-banner-dismiss" id="ollamaBannerDismiss" aria-label="Dismiss">√ó</button>
  </div>
  <button type="button" class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">‚ò∞</button>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-row">
          <div class="logo-icon" aria-hidden="true">‚ú¶</div>
          <span class="logo">AI Assistant</span>
        </div>
        <button type="button" class="btn-new-chat" id="btnNewChat"><span class="icon-plus">+</span> New Chat</button>
      </div>
      <div class="conversations-list" id="conversationsList"></div>
      <div class="sidebar-footer">
        <div class="model-select-wrap">
          <span class="model-dot" aria-hidden="true"></span>
          <select class="model-select" id="modelSelect">
            <option value="">Loading‚Ä¶</option>
          </select>
        </div>
      </div>
    </aside>
    <main class="main">
      <header class="header">
        <div class="header-left">
          <span class="header-title" id="headerTitle">AI Assistant</span>
          <span class="model-badge" id="modelBadge"><span class="pulse-dot"></span><span id="modelBadgeText">‚Äî</span></span>
        </div>
        <div class="header-actions">
          <button type="button" class="btn-header-icon" id="btnClearChat" title="Clear chat">üóë</button>
          <button type="button" class="btn-header-icon" id="btnSettings" title="Settings">‚öô</button>
        </div>
      </header>
      <div class="messages-wrap" id="messagesWrap">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-avatar" aria-hidden="true">‚ú¶</div>
          <h2 class="welcome-headline" id="welcomeHeadline">Good day, I'm your AI Assistant</h2>
          <p class="welcome-sub" id="welcomeSub">Powered by ‚Äî</p>
          <div class="suggestion-chips">
            <button type="button" class="suggestion-chip" data-prompt="Help me write an email or a short document"><span class="chip-icon">‚úçÔ∏è</span> Help me write</button>
            <button type="button" class="suggestion-chip" data-prompt="Explain this code or concept in simple terms"><span class="chip-icon">üíª</span> Explain code</button>
            <button type="button" class="suggestion-chip" data-prompt="Summarize the following text for me"><span class="chip-icon">üìÑ</span> Summarize text</button>
            <button type="button" class="suggestion-chip" data-prompt="Research and explain a topic"><span class="chip-icon">üîç</span> Research topic</button>
          </div>
        </div>
        <div id="messages"></div>
      </div>
      <div class="input-area">
        <div class="input-inner">
          <div class="input-hint" id="inputHint">Attach files (üìé), or choose files/folder (üìÅ) and type your request (summarize, translate, compare...). <button type="button" class="link-btn" id="btnShowPathPanel">Or enter folder path</button></div>
          <div class="input-wrap">
            <div class="file-chips" id="fileChips"></div>
            <div class="folder-panel" id="folderPanel">
              <input type="text" id="folderPathInput" placeholder="Folder path (e.g. C:\Users\...\project\data)" />
              <button type="button" class="btn-folder-go" id="btnFolderGo">Summarize folder</button>
              <button type="button" class="btn-folder-cancel" id="btnFolderCancel">Cancel</button>
            </div>
            <div class="input-row">
              <div class="textarea-wrap">
                <button type="button" class="btn-attach-inline" id="btnAttach" title="Attach file(s) ‚Äî select one or multiple">üìé</button>
                <div class="picker-wrap" id="pickerWrap">
                  <button type="button" class="btn-attach-inline" id="btnFolder" title="Choose files or folder">üìÅ</button>
                  <div class="picker-dropdown" id="pickerDropdown">
                    <button type="button" class="picker-option" id="pickerOptionFiles">Select multiple files</button>
                    <button type="button" class="picker-option" id="pickerOptionFolder">Select folder</button>
                  </div>
                </div>
                <textarea id="inputText" rows="1" placeholder="Message... (Shift+Enter for new line)" autocomplete="off"></textarea>
              </div>
              <div class="input-btns">
                <input type="file" id="fileInput" accept=".pdf,.docx,.txt,.csv" multiple style="display:none">
                <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
                <button type="button" class="btn-icon btn-send disabled" id="btnSend" title="Send"><span class="send-arrow">‚û§</span><span class="spinner" style="display:none"></span></button>
                <button type="button" class="btn-icon btn-stop" id="btnStop" title="Stop generation" style="display:none">‚ñ†</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="errorToast" class="error-toast" style="display:none"></div>

  <div id="settingsModal" class="settings-modal" aria-hidden="true">
    <div class="settings-modal-backdrop" id="settingsModalBackdrop"></div>
    <div class="settings-modal-panel">
      <div class="settings-modal-header">
        <h3 class="settings-modal-title">Settings</h3>
        <button type="button" class="settings-modal-close" id="settingsModalClose" aria-label="Close">√ó</button>
      </div>
      <div class="settings-modal-body">
        <form id="settingsForm" class="settings-form">
          <label class="settings-label">System prompt</label>
          <textarea id="settingsSystemPrompt" class="settings-input settings-textarea" rows="4" placeholder="Instructions for the AI..."></textarea>
          <label class="settings-label">Temperature <span class="settings-hint">(0‚Äì2)</span></label>
          <input type="number" id="settingsTemperature" class="settings-input" min="0" max="2" step="0.1" />
          <label class="settings-label">Max tokens</label>
          <input type="number" id="settingsMaxTokens" class="settings-input" min="1" max="128000" />
          <label class="settings-label">Default model</label>
          <select id="settingsDefaultModel" class="settings-input settings-select"></select>
          <div class="settings-actions">
            <button type="button" class="btn-settings-cancel" id="settingsCancel">Cancel</button>
            <button type="submit" class="btn-settings-save" id="settingsSave">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const BASE = window.location.origin;
      const WS_BASE = (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host;
      let ws = null;
      let reconnectAttempts = 0;
      const MAX_RECONNECT = 3;
      const RECONNECT_DELAYS = [1000, 3000, 6000];
      let currentConversationId = null;
      let conversations = {};
      let currentMessages = [];
      let attachedFiles = [];
      let streaming = false;
      let userScrolledUp = false;
      let scrollThreshold = 100;
      let currentConversationTitle = null;

      const messagesEl = document.getElementById('messages');
      const messagesWrap = document.getElementById('messagesWrap');
      const welcomeScreen = document.getElementById('welcomeScreen');
      const welcomeHeadline = document.getElementById('welcomeHeadline');
      const welcomeSub = document.getElementById('welcomeSub');
      const inputText = document.getElementById('inputText');
      const btnSend = document.getElementById('btnSend');
      const btnNewChat = document.getElementById('btnNewChat');
      const modelSelect = document.getElementById('modelSelect');
      const headerTitle = document.getElementById('headerTitle');
      const modelBadge = document.getElementById('modelBadge');
      const modelBadgeText = document.getElementById('modelBadgeText');
      const fileChips = document.getElementById('fileChips');
      const fileInput = document.getElementById('fileInput');
      const folderInput = document.getElementById('folderInput');
      const btnAttach = document.getElementById('btnAttach');
      const btnClearChat = document.getElementById('btnClearChat');
      const btnSettings = document.getElementById('btnSettings');
      const btnStop = document.getElementById('btnStop');
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const errorToast = document.getElementById('errorToast');
      const conversationsList = document.getElementById('conversationsList');
      const folderPanel = document.getElementById('folderPanel');
      const folderPathInput = document.getElementById('folderPathInput');
      const btnFolderGo = document.getElementById('btnFolderGo');
      const btnFolderCancel = document.getElementById('btnFolderCancel');
      const btnFolder = document.getElementById('btnFolder');
      const btnShowPathPanel = document.getElementById('btnShowPathPanel');
      const pickerWrap = document.getElementById('pickerWrap');
      const pickerDropdown = document.getElementById('pickerDropdown');
      const pickerOptionFiles = document.getElementById('pickerOptionFiles');
      const pickerOptionFolder = document.getElementById('pickerOptionFolder');
      let folderSummaryActive = false;
      const CHAT_STORAGE_KEY = 'ai_assistant_conversations';

      function loadConversationsFromStorage() {
        try {
          var raw = localStorage.getItem(CHAT_STORAGE_KEY);
          if (raw) {
            var data = JSON.parse(raw);
            if (data && typeof data === 'object') Object.assign(conversations, data);
          }
        } catch (e) {}
      }
      function saveConversationsToStorage() {
        try {
          localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(conversations));
        } catch (e) {}
      }
      function loadConversationsFromServer() {
        fetch(BASE + '/api/conversations').then(function(r) { return r.json(); }).then(function(d) {
          if (d && d.conversations && typeof d.conversations === 'object') {
            conversations = d.conversations;
            saveConversationsToStorage();
          }
          renderConversationsList();
        }).catch(function() { renderConversationsList(); });
      }
      function saveConversationToServer(id, title, messages) {
        fetch(BASE + '/api/conversations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, title: title || 'Chat', messages: messages || [] })
        }).catch(function() {});
      }
      function deleteConversationOnServer(id) {
        if (!id) return;
        fetch(BASE + '/api/conversations/' + encodeURIComponent(id), { method: 'DELETE' }).catch(function() {});
      }
      function deleteConversation(id) {
        if (!id) return;
        delete conversations[id];
        saveConversationsToStorage();
        deleteConversationOnServer(id);
        if (currentConversationId === id) {
          currentConversationId = null;
          currentConversationTitle = null;
          currentMessages = [];
          headerTitle.textContent = 'AI Assistant';
          messagesEl.innerHTML = '';
          streaming = false;
          if (window._currentStreamEl) delete window._currentStreamEl;
          removeTypingIndicator();
          setWelcomeVisibility();
        }
        renderConversationsList();
      }

      function setWelcomeVisibility() {
        var hasMessages = messagesEl.querySelectorAll('.message').length > 0;
        welcomeScreen.classList.toggle('hidden', hasMessages);
      }
      function setWelcomeContent() {
        var hour = new Date().getHours();
        var greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
        welcomeHeadline.textContent = greeting + ", I'm your AI Assistant";
        welcomeSub.textContent = 'Powered by ' + (modelSelect.value || '‚Äî');
      }
      function updateSendButton() {
        var hasText = inputText.value.trim().length > 0;
        var hasFile = attachedFiles.length > 0;
        var active = (hasText || hasFile) && !folderSummaryActive;
        btnSend.classList.toggle('disabled', !active);
        btnSend.classList.toggle('loading', streaming);
        btnSend.style.display = streaming ? 'none' : 'flex';
        if (btnStop) btnStop.style.display = streaming ? 'flex' : 'none';
        var arrow = btnSend.querySelector('.send-arrow');
        var spinnerEl = btnSend.querySelector('.spinner');
        if (arrow && spinnerEl) {
          arrow.style.display = streaming ? 'none' : '';
          spinnerEl.style.display = streaming ? 'block' : 'none';
        }
      }
      function renderConversationsList() {
        conversationsList.innerHTML = '';
        var ids = Object.keys(conversations);
        if (ids.length === 0 && !currentConversationTitle) return;
        var group = document.createElement('div');
        group.className = 'conversation-group';
        var label = document.createElement('div');
        label.className = 'conversation-group-label';
        label.textContent = 'Chats';
        group.appendChild(label);
        if (currentConversationTitle) {
          var curItem = document.createElement('div');
          curItem.className = 'conversation-item active';
          curItem.setAttribute('data-id', currentConversationId || '');
          curItem.innerHTML = '<div class="title-wrap"><div class="title">' + escapeHtml(currentConversationTitle) + '</div><div class="meta">' + (currentConversationId ? '' : 'Current') + '</div></div><div class="conversation-menu"><button type="button" class="conversation-btn-delete" aria-label="Delete chat" title="Delete chat">√ó</button><button type="button" aria-label="Clear chat" title="Clear chat">‚ãØ</button></div>';
          curItem.querySelector('.conversation-menu .conversation-btn-delete').onclick = function(e) { e.stopPropagation(); if (currentConversationId) deleteConversation(currentConversationId); else clearChat(); };
          curItem.querySelector('.conversation-menu button:last-child').onclick = function(e) { e.stopPropagation(); clearChat(); };
          curItem.onclick = function(e) { if (!e.target.closest('.conversation-menu')) loadConversation(currentConversationId); };
          group.appendChild(curItem);
        }
        ids.forEach(function(id) {
          if (id === currentConversationId) return;
          var c = conversations[id];
          if (!c) return;
          var item = document.createElement('div');
          item.className = 'conversation-item';
          item.setAttribute('data-id', id);
          item.innerHTML = '<div class="title-wrap"><div class="title">' + escapeHtml(c.title || 'Chat') + '</div><div class="meta"></div></div><div class="conversation-menu"><button type="button" class="conversation-btn-delete" aria-label="Delete chat" title="Delete chat">√ó</button></div>';
          item.querySelector('.conversation-btn-delete').onclick = function(e) { e.stopPropagation(); deleteConversation(id); };
          item.onclick = function(e) { if (!e.target.closest('.conversation-menu')) loadConversation(id); };
          group.appendChild(item);
        });
        conversationsList.appendChild(group);
      }
      function loadConversation(id) {
        if (!id || !conversations[id]) return;
        var c = conversations[id];
        currentConversationId = id;
        currentConversationTitle = c.title || 'Chat';
        currentMessages = (c.messages || []).slice();
        headerTitle.textContent = currentConversationTitle;
        messagesEl.innerHTML = '';
        (c.messages || []).forEach(function(m) {
          addMessage(m.content, m.role === 'user', false);
        });
        setWelcomeVisibility();
        renderConversationsList();
      }
      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function safeMarkdown(text) {
        if (typeof marked === 'undefined') return escapeHtml(text || '');
        var raw = (text || '');
        var html = marked.parse(raw);
        if (typeof DOMPurify !== 'undefined') html = DOMPurify.sanitize(html);
        return html;
      }
      function clearChat() {
        if (currentMessages.length > 0) {
          var id = currentConversationId || 'c' + Date.now();
          conversations[id] = { title: currentConversationTitle || 'Chat', messages: currentMessages.slice() };
          saveConversationsToStorage();
          saveConversationToServer(id, currentConversationTitle || 'Chat', currentMessages);
        }
        currentConversationId = null;
        currentConversationTitle = null;
        currentMessages = [];
        headerTitle.textContent = 'AI Assistant';
        messagesEl.innerHTML = '';
        streaming = false;
        if (window._currentStreamEl) delete window._currentStreamEl;
        removeTypingIndicator();
        setWelcomeVisibility();
        renderConversationsList();
      }

      function showError(msg) {
        errorToast.textContent = msg;
        errorToast.style.display = 'block';
        setTimeout(function() { errorToast.style.display = 'none'; }, 5000);
      }

      function connect() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        const url = WS_BASE + '/ws';
        ws = new WebSocket(url);
        ws.onopen = function() {
          reconnectAttempts = 0;
          loadModels();
          loadConversationsFromServer();
        };
        ws.onclose = function() {
          if (reconnectAttempts < MAX_RECONNECT) {
            const delay = RECONNECT_DELAYS[reconnectAttempts] || 6000;
            setTimeout(connect, delay);
            reconnectAttempts++;
          }
        };
        ws.onerror = function() {};
        ws.onmessage = function(ev) {
          try {
            const data = JSON.parse(ev.data);
            if (data.type === 'token' && window._currentStreamEl) {
              var contentEl = window._currentStreamEl;
              var typingDots = contentEl.querySelector('.typing-dots');
              if (typingDots) {
                typingDots.remove();
                contentEl.textContent = data.content || '';
              } else {
                contentEl.textContent += data.content || '';
              }
              if (!userScrolledUp) scrollToBottom();
            } else if (data.type === 'done') {
              if (window._currentStreamEl) {
                const contentEl = window._currentStreamEl;
                const full = (contentEl.getAttribute('data-raw') || '') + contentEl.textContent;
                currentMessages.push({ role: 'assistant', content: full });
                const rendered = safeMarkdown(full);
                contentEl.innerHTML = rendered;
                contentEl.removeAttribute('data-raw');
                var block = contentEl.closest('.message');
                if (block) {
                  block.querySelectorAll('pre code').forEach(function(el) {
                    hljs.highlightElement(el);
                    var pre = el.closest('pre');
                    if (pre && !pre.querySelector('.copy-btn')) {
                      var btn = document.createElement('button');
                      btn.className = 'copy-btn';
                      btn.textContent = 'Copy';
                      btn.onclick = function() {
                        navigator.clipboard.writeText(el.textContent);
                        btn.textContent = 'Copied!';
                        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
                      };
                      pre.style.paddingTop = '32px';
                      pre.appendChild(btn);
                    }
                  });
                  var body = block.querySelector('.message-body');
                  if (body && !body.querySelector('.copy-msg-btn')) {
                    var copyMsgBtn = document.createElement('button');
                    copyMsgBtn.className = 'copy-msg-btn';
                    copyMsgBtn.type = 'button';
                    copyMsgBtn.title = 'Copy message';
                    copyMsgBtn.textContent = '‚éò';
                    copyMsgBtn.onclick = function() {
                      var el = block.querySelector('.message-content');
                      var text = (el && (el.innerText || el.textContent || '')) ? (el.innerText || el.textContent).trim() : '';
                      if (text) {
                        navigator.clipboard.writeText(text);
                        copyMsgBtn.textContent = '‚úì';
                        setTimeout(function() { copyMsgBtn.textContent = '‚éò'; }, 2000);
                      }
                    };
                    body.appendChild(copyMsgBtn);
                  }
                }
                delete window._currentStreamEl;
              }
              streaming = false;
              updateSendButton();
              removeTypingIndicator();
              scrollToBottom();
              inputText.focus();
            } else if (data.type === 'error') {
              removeTypingIndicator();
              if (window._currentStreamEl) {
                var contentEl = window._currentStreamEl;
                var typingDots = contentEl.querySelector('.typing-dots');
                if (typingDots) typingDots.remove();
                var errText = 'Error: ' + (data.message || 'Unknown error');
                contentEl.textContent = errText;
                currentMessages.push({ role: 'assistant', content: errText });
                delete window._currentStreamEl;
              }
              streaming = false;
              folderSummaryActive = false;
              updateSendButton();
              showError(data.message || 'Error');
            } else if (data.type === 'folder_file') {
              var fn = data.name || 'File';
              var sum = data.summary || '';
              var err = data.error || '';
              var content = '**' + fn + '**\n\n' + (err ? '(Error: ' + err + ')' : sum);
              addMessage(content, false, false);
              scrollToBottom();
            } else if (data.type === 'folder_done') {
              folderSummaryActive = false;
              updateSendButton();
            }
          } catch (e) {}
        };
      }

      function loadModels() {
        fetch(BASE + '/api/models').then(function(r) { return r.json(); }).then(function(d) {
          const list = d.models || [];
          const ollamaOk = d.ollama_ok !== false;
          modelSelect.innerHTML = '';
          if (list.length === 0) modelSelect.innerHTML = '<option value="">(No models)</option>';
          else list.forEach(function(m) {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = m;
            modelSelect.appendChild(opt);
          });
          modelBadgeText.textContent = modelSelect.value || '‚Äî';
          setWelcomeContent();
          if (list.length === 0 && welcomeSub) {
            welcomeSub.textContent = 'Install a model: run ollama pull <model> in terminal (e.g. ollama pull llama3.2).';
          }
          var banner = document.getElementById('ollamaBanner');
          var bannerText = document.getElementById('ollamaBannerText');
          if (banner && bannerText) {
            if (!ollamaOk) {
              bannerText.textContent = 'Ollama is not running. Start Ollama (e.g. ollama serve or open the Ollama app), then refresh. ';
              banner.style.display = 'flex';
            } else if (list.length === 0) {
              bannerText.textContent = 'No models installed. Run in terminal: ollama pull llama3.2 (or another model). ';
              banner.style.display = 'flex';
            } else {
              banner.style.display = 'none';
            }
          }
        }).catch(function() {
          modelSelect.innerHTML = '<option value="">(Failed to load)</option>';
          var banner = document.getElementById('ollamaBanner');
          var bannerText = document.getElementById('ollamaBannerText');
          if (banner && bannerText) {
            bannerText.textContent = 'Could not reach the server. Check that the app is running and refresh. ';
            banner.style.display = 'flex';
          }
        });
      }
      modelSelect.addEventListener('change', function() {
        modelBadgeText.textContent = modelSelect.value || '‚Äî';
        setWelcomeContent();
      });

      function scrollToBottom() {
        messagesWrap.scrollTop = messagesWrap.scrollHeight;
      }
      messagesWrap.addEventListener('scroll', function() {
        const nearBottom = messagesWrap.scrollHeight - messagesWrap.scrollTop - messagesWrap.clientHeight < scrollThreshold;
        userScrolledUp = !nearBottom;
      });

      function addMessage(content, isUser, isStreaming) {
        if (isUser && content && !currentConversationTitle) {
          currentConversationTitle = content.length > 50 ? content.slice(0, 50) + '‚Ä¶' : content;
          headerTitle.textContent = currentConversationTitle;
          renderConversationsList();
        }
        const block = document.createElement('div');
        block.className = 'message ' + (isUser ? 'user' : 'assistant');
        if (!isUser) {
          const av = document.createElement('div');
          av.className = 'avatar';
          av.textContent = '‚óÜ';
          block.appendChild(av);
        }
        const contentWrap = document.createElement('div');
        contentWrap.className = 'message-body';
        const contentEl = document.createElement('div');
        contentEl.className = 'message-content';
        if (isStreaming) {
          contentEl.setAttribute('data-raw', '');
          var typingWrap = document.createElement('div');
          typingWrap.className = 'typing-dots';
          typingWrap.innerHTML = '<span></span><span></span><span></span>';
          contentEl.appendChild(typingWrap);
          window._currentStreamEl = contentEl;
        } else if (isUser) {
          contentEl.textContent = content;
        } else {
          contentEl.innerHTML = safeMarkdown(content || '');
          contentEl.querySelectorAll('pre code').forEach(function(el) {
            hljs.highlightElement(el);
            const pre = el.closest('pre');
            if (pre && !pre.querySelector('.copy-btn')) {
              const btn = document.createElement('button');
              btn.className = 'copy-btn';
              btn.textContent = 'Copy';
              btn.onclick = function() {
                navigator.clipboard.writeText(el.textContent);
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
              };
              pre.style.paddingTop = '32px';
              pre.appendChild(btn);
            }
          });
        }
        contentWrap.appendChild(contentEl);
        var timeStr = new Date().toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        var timeEl = document.createElement('span');
        timeEl.className = 'message-time';
        timeEl.setAttribute('aria-hidden', 'true');
        timeEl.textContent = timeStr;
        contentWrap.appendChild(timeEl);
        if (!isUser && !isStreaming) {
          var copyMsgBtn = document.createElement('button');
          copyMsgBtn.className = 'copy-msg-btn';
          copyMsgBtn.type = 'button';
          copyMsgBtn.title = 'Copy message';
          copyMsgBtn.textContent = '‚éò';
          copyMsgBtn.onclick = function() {
            var text = (contentEl.innerText || contentEl.textContent || '').trim();
            if (text) {
              navigator.clipboard.writeText(text);
              copyMsgBtn.textContent = '‚úì';
              setTimeout(function() { copyMsgBtn.textContent = '‚éò'; }, 2000);
            }
          };
          contentWrap.appendChild(copyMsgBtn);
        }
        block.appendChild(contentWrap);
        messagesEl.appendChild(block);
        setWelcomeVisibility();
        return block;
      }

      function addTypingIndicator() {
        const block = document.createElement('div');
        block.className = 'message assistant';
        block.id = 'typingIndicator';
        block.innerHTML = '<div class="avatar">‚óÜ</div><div class="message-content"><div class="typing-dots"><span></span><span></span><span></span></div></div>';
        messagesEl.appendChild(block);
        scrollToBottom();
      }
      function removeTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if (el) el.remove();
      }

      function sendMessage() {
        const text = inputText.value.trim();
        if (!text && attachedFiles.length === 0) return;
        if (streaming) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          showError('Not connected. Retrying...');
          connect();
          return;
        }
        var fileIds = attachedFiles.map(function(f) { return f.id; });
        var userDisplayContent = text || (fileIds.length > 0 ? fileIds.length + ' file(s) attached' : '');
        currentMessages.push({ role: 'user', content: userDisplayContent });
        streaming = true;
        updateSendButton();
        if (text) addMessage(text, true);
        else if (fileIds.length > 0) addMessage(fileIds.length + ' file(s) attached', true);
        inputText.value = '';
        if (attachedFiles.length > 0) {
          attachedFiles = [];
          renderFileChips();
        }
        var payload = { type: 'chat', message: text || '', model: modelSelect.value || undefined, history: currentMessages };
        if (fileIds.length === 1) payload.file_id = fileIds[0];
        else if (fileIds.length > 1) payload.file_ids = fileIds;
        ws.send(JSON.stringify(payload));
        addMessage('', false, true);
        inputText.focus();
      }

      btnSend.addEventListener('click', sendMessage);
      if (btnStop) {
        btnStop.addEventListener('click', function() {
          if (!streaming || !ws || ws.readyState !== WebSocket.OPEN) return;
          ws.send(JSON.stringify({ type: 'stop' }));
        });
      }
      inputText.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      function autoResize(ta) {
        ta.style.height = 'auto';
        ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
      }
      inputText.addEventListener('input', function() { autoResize(this); updateSendButton(); });

      document.querySelectorAll('.suggestion-chip').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var prompt = btn.getAttribute('data-prompt') || btn.textContent.trim();
          inputText.value = prompt;
          inputText.focus();
          autoResize(inputText);
          updateSendButton();
        });
      });

      btnNewChat.addEventListener('click', function() { clearChat(); });
      btnClearChat.addEventListener('click', function() { clearChat(); });
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          clearChat();
        }
      });
      (function setupSettings() {
        var modal = document.getElementById('settingsModal');
        var backdrop = document.getElementById('settingsModalBackdrop');
        var closeBtn = document.getElementById('settingsModalClose');
        var form = document.getElementById('settingsForm');
        var systemPromptEl = document.getElementById('settingsSystemPrompt');
        var temperatureEl = document.getElementById('settingsTemperature');
        var maxTokensEl = document.getElementById('settingsMaxTokens');
        var defaultModelEl = document.getElementById('settingsDefaultModel');

        function openSettings() {
          modal.classList.add('open');
          modal.setAttribute('aria-hidden', 'false');
          fetch(BASE + '/api/config')
            .then(function(r) { return r.json(); })
            .then(function(cfg) {
              systemPromptEl.value = cfg.system_prompt || '';
              temperatureEl.value = cfg.temperature != null ? cfg.temperature : 0.7;
              maxTokensEl.value = cfg.max_tokens != null ? cfg.max_tokens : 2048;
              var currentDefault = (cfg.default_model || '').trim();
              fetch(BASE + '/api/models')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                  var models = d.models || [];
                  defaultModelEl.innerHTML = '';
                  if (currentDefault && models.indexOf(currentDefault) === -1) {
                    var opt = document.createElement('option');
                    opt.value = currentDefault;
                    opt.textContent = currentDefault + ' (config)';
                    defaultModelEl.appendChild(opt);
                  }
                  models.forEach(function(m) {
                    var opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === currentDefault) opt.selected = true;
                    defaultModelEl.appendChild(opt);
                  });
                  if (!defaultModelEl.value && models.length) defaultModelEl.value = models[0];
                  if (!defaultModelEl.value && currentDefault) defaultModelEl.value = currentDefault;
                })
                .catch(function() { defaultModelEl.innerHTML = '<option value="">(load failed)</option>'; });
            })
            .catch(function() {
              systemPromptEl.value = '';
              temperatureEl.value = 0.7;
              maxTokensEl.value = 2048;
            });
        }

        function closeSettings() {
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden', 'true');
        }

        btnSettings.addEventListener('click', openSettings);
        if (closeBtn) closeBtn.addEventListener('click', closeSettings);
        if (backdrop) backdrop.addEventListener('click', closeSettings);
        document.getElementById('settingsCancel').addEventListener('click', closeSettings);

        form.addEventListener('submit', function(e) {
          e.preventDefault();
          var payload = {
            system_prompt: systemPromptEl.value.trim(),
            temperature: parseFloat(temperatureEl.value) || 0.7,
            max_tokens: parseInt(maxTokensEl.value, 10) || 2048,
            default_model: defaultModelEl.value || undefined
          };
          fetch(BASE + '/api/config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then(function(r) {
              if (!r.ok) return r.text().then(function(t) { throw new Error(t || r.status); });
              return r.json();
            })
            .then(function() {
              var newModel = payload.default_model || defaultModelEl.value;
              if (newModel) {
                modelSelect.value = newModel;
                if (modelSelect.value !== newModel) {
                  var opt = document.createElement('option');
                  opt.value = newModel;
                  opt.textContent = newModel;
                  modelSelect.appendChild(opt);
                  modelSelect.value = newModel;
                }
                modelBadgeText.textContent = newModel;
                setWelcomeContent();
              }
              closeSettings();
              showError('Settings saved.');
            })
            .catch(function(err) {
              showError(err.message || 'Failed to save settings.');
            });
        });
      })();

      btnFolder.addEventListener('click', function(e) {
        e.stopPropagation();
        pickerWrap.classList.toggle('open');
      });
      pickerOptionFiles.addEventListener('click', function() {
        pickerWrap.classList.remove('open');
        fileInput.click();
      });
      pickerOptionFolder.addEventListener('click', function() {
        pickerWrap.classList.remove('open');
        folderInput.click();
      });
      pickerDropdown.addEventListener('click', function(e) { e.stopPropagation(); });
      document.addEventListener('click', function() {
        pickerWrap.classList.remove('open');
      });
      folderInput.addEventListener('change', function() {
        var files = this.files;
        if (!files || files.length === 0) { this.value = ''; return; }
        var allowed = ['.pdf', '.docx', '.txt', '.csv'];
        function uploadOne(file) {
          var form = new FormData();
          form.append('file', file);
          return fetch(BASE + '/upload', { method: 'POST', body: form })
            .then(function(r) {
              if (!r.ok) return r.text().then(function(t) { throw new Error(t || r.status); });
              return r.json();
            })
            .then(function(d) { return { id: d.file_id, name: d.name || file.name }; });
        }
        var list = [];
        for (var i = 0; i < files.length; i++) {
          var ext = (files[i].name || '').toLowerCase().replace(/.*\./, '.');
          if (allowed.indexOf(ext) !== -1) list.push(files[i]);
        }
        this.value = '';
        if (list.length === 0) { showError('No supported files (.pdf, .docx, .txt, .csv) in that folder'); return; }
        if (!ws || ws.readyState !== WebSocket.OPEN) { showError('Not connected. Retrying...'); connect(); return; }
        var idx = 0;
        var uploaded = [];
        var inputEl = this;
        function next() {
          if (idx >= list.length) {
            uploaded.forEach(function(item) { attachedFiles.push(item); });
            renderFileChips();
            updateSendButton();
            return;
          }
          uploadOne(list[idx]).then(function(item) {
            uploaded.push(item);
            idx++;
            next();
          }).catch(function(e) {
            showError(e.message || 'Upload failed');
            idx++;
            next();
          });
        }
        next();
      });
      btnShowPathPanel.addEventListener('click', function() {
        folderPanel.classList.toggle('open');
        if (folderPanel.classList.contains('open')) folderPathInput.focus();
      });
      btnFolderCancel.addEventListener('click', function() {
        folderPanel.classList.remove('open');
        folderPathInput.value = '';
      });
      btnFolderGo.addEventListener('click', function() {
        var path = folderPathInput.value.trim();
        if (!path) { showError('Enter a folder path'); return; }
        if (!ws || ws.readyState !== WebSocket.OPEN) { showError('Not connected. Retrying...'); connect(); return; }
        folderSummaryActive = true;
        updateSendButton();
        addMessage('Summarize folder: ' + path, true, false);
        folderPanel.classList.remove('open');
        folderPathInput.value = '';
        ws.send(JSON.stringify({ type: 'folder_summary', folder_path: path, recursive: true, model: modelSelect.value || undefined }));
      });
      folderPathInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); btnFolderGo.click(); }
      });

      function renderFileChips() {
        fileChips.innerHTML = '';
        attachedFiles.forEach(function(file, idx) {
          var chip = document.createElement('div');
          chip.className = 'file-chip';
          var displayName = file.name.length > 24 ? file.name.slice(0, 24) + '‚Ä¶' : file.name;
          chip.innerHTML = 'üìÑ ' + escapeHtml(displayName) + ' <button type="button" aria-label="Remove">√ó</button>';
          chip.querySelector('button').onclick = function() {
            attachedFiles.splice(idx, 1);
            renderFileChips();
            updateSendButton();
          };
          fileChips.appendChild(chip);
        });
      }
      btnAttach.addEventListener('click', function() { fileInput.click(); });
      fileInput.addEventListener('change', function() {
        var files = this.files;
        if (!files || files.length === 0) return;
        var allowed = ['.pdf', '.docx', '.txt', '.csv'];
        function uploadOne(file) {
          return fetch(BASE + '/upload', { method: 'POST', body: (function() { var f = new FormData(); f.append('file', file); return f; })() })
            .then(function(r) {
              if (!r.ok) return r.text().then(function(t) { throw new Error(t || r.status); });
              return r.json();
            })
            .then(function(d) { return { id: d.file_id, name: d.name || file.name }; });
        }
        var i = 0;
        var inputEl = this;
        function next() {
          if (i >= files.length) { inputEl.value = ''; return; }
          var file = files[i];
          var ext = (file.name || '').toLowerCase().replace(/.*\./, '.');
          if (allowed.indexOf(ext) === -1) { i++; next(); return; }
          uploadOne(file).then(function(item) {
            attachedFiles.push(item);
            renderFileChips();
            updateSendButton();
            i++;
            next();
          }).catch(function(e) {
            showError(e.message || 'Upload failed');
            i++;
            next();
          });
        }
        next();
      });
      messagesWrap.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
      messagesWrap.addEventListener('drop', function(e) {
        e.preventDefault();
        var droppedFiles = e.dataTransfer.files;
        if (!droppedFiles || droppedFiles.length === 0) return;
        var allowed = ['.pdf', '.docx', '.txt', '.csv'];
        var list = [];
        for (var idx = 0; idx < droppedFiles.length; idx++) {
          var ext = (droppedFiles[idx].name || '').toLowerCase().replace(/.*\./, '.');
          if (allowed.indexOf(ext) !== -1) list.push(droppedFiles[idx]);
        }
        if (list.length === 0) {
          showError('Supported formats: .pdf, .docx, .txt, .csv');
          return;
        }
        function uploadOne(file) {
          var form = new FormData();
          form.append('file', file);
          return fetch(BASE + '/upload', { method: 'POST', body: form })
            .then(function(r) {
              if (!r.ok) return r.text().then(function(t) { throw new Error(t || r.status); });
              return r.json();
            })
            .then(function(d) { return { id: d.file_id, name: d.name || file.name }; });
        }
        var i = 0;
        function next() {
          if (i >= list.length) return;
          var file = list[i];
          uploadOne(file).then(function(item) {
            attachedFiles.push(item);
            renderFileChips();
            updateSendButton();
            i++;
            next();
          }).catch(function(e) {
            showError(e.message || 'Upload failed');
            i++;
            next();
          });
        }
        next();
      });

      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
      });

      connect();
      updateSendButton();
      setWelcomeVisibility();
      setWelcomeContent();
      loadConversationsFromStorage();
      renderConversationsList();
      inputText.focus();
      (function setupOllamaBanner() {
        var dismiss = document.getElementById('ollamaBannerDismiss');
        var banner = document.getElementById('ollamaBanner');
        if (dismiss && banner) {
          dismiss.addEventListener('click', function() { banner.style.display = 'none'; });
        }
      })();
    })();
  </script>
</body>
</html>
